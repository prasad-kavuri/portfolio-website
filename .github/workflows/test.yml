name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        echo "Installing dependencies..."
        npm install
        echo "✅ Dependencies installed"
    
    - name: List project structure
      run: |
        echo "=== Project Structure ==="
        echo "HTML files:"
        ls -la *.html | head -20
        echo ""
        echo "JavaScript files:"
        ls -la *.js | head -20
        echo ""
        echo "Config files:"
        ls -la .*rc.json package*.json 2>/dev/null || true
    
    - name: Run linting
      run: |
        echo "=== Running ESLint ==="
        npm run lint || echo "⚠️ Linting completed with warnings"
      continue-on-error: true
    
    - name: Run unit tests
      run: |
        echo "=== Running Unit Tests ==="
        npm test || echo "⚠️ Some tests failed"
      continue-on-error: true
    
    - name: Check critical files
      run: |
        echo "=== Verifying Critical Files ==="
        
        critical_files=(
          "index.html"
          "rag-pipeline.html"
          "package.json"
        )
        
        all_found=true
        for file in "${critical_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file exists"
          else
            echo "❌ $file is missing"
            all_found=false
          fi
        done
        
        if [ "$all_found" = true ]; then
          echo "✅ All critical files present!"
        else
          echo "❌ Some critical files are missing"
          exit 1
        fi

  check-files:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: List all files
      run: |
        echo "📁 Repository contents:"
        ls -la
        
        echo -e "\n📄 HTML files:"
        ls -la *.html 2>/dev/null || echo "No HTML files found"
        
        echo -e "\n📜 JavaScript files:"
        ls -la *.js 2>/dev/null || echo "No JS files found"
        
        echo -e "\n📦 Package files:"
        ls -la package*.json 2>/dev/null || echo "No package files found"

  deploy-pages:
    needs: [test-and-validate, check-files]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4