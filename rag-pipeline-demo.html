<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Pipeline Demo - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .input-section {
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .query-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .query-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .example-queries {
            margin-top: 15px;
        }

        .example-queries h4 {
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .example-btn {
            display: inline-block;
            margin: 5px;
            padding: 8px 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .example-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .knowledge-base {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .knowledge-base h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kb-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .kb-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 14px;
        }

        .kb-stat .label {
            color: #666;
        }

        .kb-stat .value {
            font-weight: 600;
            color: #333;
        }

        .pipeline-stage {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            opacity: 0;
            transform: translateX(-20px);
            animation: slideIn 0.5s forwards;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .stage-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .stage-number {
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .stage-title {
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
        }

        .stage-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #e2e3e5;
            color: #383d41;
        }

        .stage-content {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .stage-content ul {
            list-style: none;
            margin-top: 10px;
        }

        .stage-content li {
            padding: 5px 0;
            display: flex;
            align-items: center;
        }

        .stage-content li:before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            margin-right: 10px;
        }

        .metrics-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .metrics-panel h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .metric {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .retrieved-docs {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .doc-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .doc-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .doc-similarity {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .doc-excerpt {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
            margin-top: 8px;
        }

        /* Fade in animation for stages */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ RAG Pipeline Demo</h1>
            <p>Retrieval-Augmented Generation System</p>
        </div>

        <div class="main-content">
            <!-- Left Panel: Input & Configuration -->
            <div class="panel">
                <h2>Query Input</h2>

                <div class="input-section">
                    <label for="queryInput">Enter your query:</label>
                    <textarea id="queryInput" class="query-input" rows="3"
                        placeholder="Describe your approach to cloud migration and infrastructure optimization">Describe your approach to cloud migration and infrastructure optimization</textarea>

                    <div class="example-queries">
                        <h4>Try these example queries:</h4>
                        <button class="example-btn" onclick="setQuery('Cost & Performance Optimization')">Cost &
                            Performance Optimization</button>
                        <button class="example-btn" onclick="setQuery('Technical Architecture')">Technical
                            Architecture</button>
                        <button class="example-btn" onclick="setQuery('Leadership & Scaling')">Leadership &
                            Scaling</button>
                        <button class="example-btn" onclick="setQuery('Agentic AI Expertise')">Agentic AI
                            Expertise</button>
                        <button class="example-btn" onclick="setQuery('Cloud & DevOps')">Cloud & DevOps</button>
                    </div>
                </div>

                <div class="knowledge-base">
                    <h3>üìö Knowledge Base</h3>
                    <div class="kb-stats">
                        <div class="kb-stat">
                            <span class="label">Documents:</span>
                            <span class="value">47 docs</span>
                        </div>
                        <div class="kb-stat">
                            <span class="label">Vector Dimensions:</span>
                            <span class="value">1536</span>
                        </div>
                        <div class="kb-stat">
                            <span class="label">Embedding Model:</span>
                            <span class="value">text-embedding-ada-002</span>
                        </div>
                        <div class="kb-stat">
                            <span class="label">Index Type:</span>
                            <span class="value">FAISS</span>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="processBtn" class="btn btn-primary" onclick="processWithRAG()">
                        üîç Process with RAG
                    </button>
                    <button class="btn btn-secondary" onclick="clearPipeline()">
                        üóëÔ∏è Clear Pipeline
                    </button>
                </div>

                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>
            </div>

            <!-- Right Panel: Results & Metrics -->
            <div class="panel">
                <h2>Pipeline Execution</h2>
                <div id="pipelineStages"></div>

                <div id="metricsPanel" class="metrics-panel" style="display: none;">
                    <h3>üìä Pipeline Metrics</h3>
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-label">Query Processing</div>
                            <div class="metric-value" id="queryTime">-</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Vector Search</div>
                            <div class="metric-value" id="searchTime">-</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Documents Retrieved</div>
                            <div class="metric-value" id="docsCount">-</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Avg Similarity</div>
                            <div class="metric-value" id="avgSimilarity">-</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Generation Time</div>
                            <div class="metric-value" id="genTime">-</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Total Pipeline</div>
                            <div class="metric-value" id="totalTime">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Retrieved Documents Section -->
        <div class="panel" id="retrievedDocsPanel" style="display: none;">
            <h2>üìÑ Retrieved Documents</h2>
            <div id="retrievedDocs" class="retrieved-docs"></div>
        </div>
    </div>

    <script>
        // Pipeline state management
        let pipelineState = {
            isProcessing: false,
            currentStage: 0,
            startTime: null,
            stageTimings: {},
            documents: []
        };

        // Safe DOM element getter with error handling
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
                return null;
            }
            return element;
        }

        // Safe innerHTML setter with error handling
        function safeSetHTML(elementId, html) {
            const element = safeGetElement(elementId);
            if (element) {
                try {
                    element.innerHTML = html;
                    return true;
                } catch (error) {
                    console.error(`Error setting innerHTML for ${elementId}:`, error);
                    return false;
                }
            }
            return false;
        }

        // Safe style setter
        function safeSetStyle(elementId, property, value) {
            const element = safeGetElement(elementId);
            if (element && element.style) {
                try {
                    element.style[property] = value;
                    return true;
                } catch (error) {
                    console.error(`Error setting style for ${elementId}:`, error);
                    return false;
                }
            }
            return false;
        }

        // Set query from example buttons
        function setQuery(query) {
            const input = safeGetElement('queryInput');
            if (input) {
                input.value = query;
                // Add visual feedback
                input.style.backgroundColor = '#f0f8ff';
                setTimeout(() => {
                    input.style.backgroundColor = '';
                }, 300);
            }
        }

        // Clear pipeline
        function clearPipeline() {
            // Reset state
            pipelineState = {
                isProcessing: false,
                currentStage: 0,
                startTime: null,
                stageTimings: {},
                documents: []
            };

            // Clear stages
            safeSetHTML('pipelineStages', '');

            // Hide panels
            safeSetStyle('metricsPanel', 'display', 'none');
            safeSetStyle('retrievedDocsPanel', 'display', 'none');

            // Clear messages
            safeSetStyle('errorMessage', 'display', 'none');
            safeSetStyle('successMessage', 'display', 'none');

            // Reset button state
            const processBtn = safeGetElement('processBtn');
            if (processBtn) {
                processBtn.disabled = false;
                processBtn.innerHTML = 'üîç Process with RAG';
            }
        }

        // Show error message
        function showError(message) {
            const errorElement = safeGetElement('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }
        }

        // Show success message
        function showSuccess(message) {
            const successElement = safeGetElement('successMessage');
            if (successElement) {
                successElement.textContent = message;
                successElement.style.display = 'block';
                setTimeout(() => {
                    successElement.style.display = 'none';
                }, 3000);
            }
        }

        // Create pipeline stage HTML
        function createStageHTML(number, title, status = 'pending', content = '') {
            const statusClass = `status-${status}`;
            const statusText = status.charAt(0).toUpperCase() + status.slice(1);

            return `
                <div class="pipeline-stage" style="animation-delay: ${(number - 1) * 0.1}s">
                    <div class="stage-header">
                        <div class="stage-title">
                            <span class="stage-number">${number}</span>
                            ${title}
                        </div>
                        <span class="stage-status ${statusClass}">${statusText}</span>
                    </div>
                    ${content ? `<div class="stage-content">${content}</div>` : ''}
                </div>
            `;
        }

        // Update pipeline stage
        function updateStage(stageNumber, status, content = '') {
            const stagesContainer = safeGetElement('pipelineStages');
            if (!stagesContainer) return;

            const stages = stagesContainer.querySelectorAll('.pipeline-stage');
            if (stages[stageNumber - 1]) {
                const stage = stages[stageNumber - 1];
                const statusElement = stage.querySelector('.stage-status');
                const contentElement = stage.querySelector('.stage-content');

                if (statusElement) {
                    statusElement.className = `stage-status status-${status}`;
                    statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                }

                if (content && contentElement) {
                    contentElement.innerHTML = content;
                } else if (content && !contentElement) {
                    const newContent = document.createElement('div');
                    newContent.className = 'stage-content';
                    newContent.innerHTML = content;
                    stage.appendChild(newContent);
                }
            }
        }

        // Simulate document retrieval
        function simulateDocumentRetrieval() {
            const sampleDocs = [
                {
                    title: "Krutrim Experience - Agentic AI Platform Architecture",
                    similarity: 0.92,
                    excerpt: "Our agentic AI platform leverages multi-agent orchestration with advanced LLM capabilities, enabling autonomous task execution and intelligent decision-making across enterprise workflows..."
                },
                {
                    title: "Ola Maps B2B Platform - Scaling to 13,000+ Customers",
                    similarity: 0.87,
                    excerpt: "Successfully scaled geospatial infrastructure to serve over 13,000 B2B customers with 99.9% uptime. Implemented distributed caching and edge computing for sub-100ms response times..."
                },
                {
                    title: "HERE Technologies - Autonomous Driving Solutions",
                    similarity: 0.85,
                    excerpt: "Led the development of HD mapping systems for Level 4 autonomous vehicles, processing 50TB+ of sensor data daily with real-time localization accuracy within 10cm..."
                }
            ];

            return sampleDocs;
        }

        // Process with RAG
        async function processWithRAG() {
            // Check if already processing
            if (pipelineState.isProcessing) {
                showError('Pipeline is already processing. Please wait...');
                return;
            }

            const queryInput = safeGetElement('queryInput');
            if (!queryInput || !queryInput.value.trim()) {
                showError('Please enter a query to process');
                return;
            }

            // Initialize pipeline
            pipelineState.isProcessing = true;
            pipelineState.startTime = Date.now();
            clearPipeline();

            const processBtn = safeGetElement('processBtn');
            if (processBtn) {
                processBtn.disabled = true;
                processBtn.innerHTML = '<span class="loading-spinner"></span> Processing...';
            }

            try {
                // Initialize stages
                const stagesHTML =
                    createStageHTML(1, 'Query Processing & Embedding', 'processing') +
                    createStageHTML(2, 'Document Retrieval & Similarity Search', 'pending') +
                    createStageHTML(3, 'Context Augmentation & Ranking', 'pending') +
                    createStageHTML(4, 'Response Generation', 'pending');

                safeSetHTML('pipelineStages', stagesHTML);

                // Stage 1: Query Processing
                await simulateStage(1, async () => {
                    const queryLength = queryInput.value.length;
                    const content = `
                        <ul>
                            <li>Length: ${queryLength} characters</li>
                            <li>Complexity Score: ${Math.min(10, Math.floor(queryLength / 10))}/10</li>
                            <li>Detected Intent: general</li>
                            <li>Model: text-embedding-ada-002</li>
                            <li>Vector Dimensions: 1536</li>
                            <li>Status: ‚úÖ Ready for similarity search</li>
                        </ul>
                    `;
                    updateStage(1, 'completed', content);
                    pipelineState.stageTimings.query = 250;
                });

                // Stage 2: Document Retrieval
                await simulateStage(2, async () => {
                    pipelineState.documents = simulateDocumentRetrieval();
                    const content = `
                        <ul>
                            <li>Index: FAISS with 47 documents</li>
                            <li>Search Strategy: Cosine similarity</li>
                            <li>Retrieved top-k documents: ${pipelineState.documents.length}</li>
                            <li>Average similarity score: ${(pipelineState.documents.reduce((acc, doc) => acc + doc.similarity, 0) / pipelineState.documents.length).toFixed(2)}</li>
                        </ul>
                    `;
                    updateStage(2, 'completed', content);
                    pipelineState.stageTimings.search = 180;
                });

                // Stage 3: Context Augmentation
                await simulateStage(3, async () => {
                    const content = `
                        <ul>
                            <li>Cross-encoder reranking: ‚úÖ Completed</li>
                            <li>Context window: Optimized to 3,247 tokens</li>
                            <li>Relevance boost: +15% average score</li>
                            <li>Context ready for generation</li>
                        </ul>
                    `;
                    updateStage(3, 'completed', content);
                    pipelineState.stageTimings.augmentation = 320;
                });

                // Stage 4: Response Generation
                await simulateStage(4, async () => {
                    const content = `
                        <ul>
                            <li>Model: GPT-4 Turbo</li>
                            <li>Temperature: 0.7</li>
                            <li>Max tokens: 2048</li>
                            <li>Response generated successfully</li>
                        </ul>
                    `;
                    updateStage(4, 'completed', content);
                    pipelineState.stageTimings.generation = 1895;
                });

                // Show metrics
                showMetrics();

                // Show retrieved documents
                showRetrievedDocuments();

                // Show success message
                showSuccess('Pipeline executed successfully!');

            } catch (error) {
                console.error('Pipeline error:', error);
                showError(`Pipeline error: ${error.message || 'Unknown error occurred'}`);
            } finally {
                // Reset button state
                pipelineState.isProcessing = false;
                if (processBtn) {
                    processBtn.disabled = false;
                    processBtn.innerHTML = 'üîç Process with RAG';
                }
            }
        }

        // Simulate a pipeline stage with delay
        async function simulateStage(stageNumber, callback) {
            updateStage(stageNumber, 'processing');
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 500));
            await callback();
        }

        // Show metrics panel
        function showMetrics() {
            const metricsPanel = safeGetElement('metricsPanel');
            if (!metricsPanel) return;

            metricsPanel.style.display = 'block';

            const totalTime = Object.values(pipelineState.stageTimings).reduce((a, b) => a + b, 0);
            const avgSimilarity = pipelineState.documents.length > 0
                ? (pipelineState.documents.reduce((acc, doc) => acc + doc.similarity, 0) / pipelineState.documents.length * 100).toFixed(0)
                : 0;

            safeSetHTML('queryTime', `${pipelineState.stageTimings.query || 0} ms`);
            safeSetHTML('searchTime', `${pipelineState.stageTimings.search || 0} ms`);
            safeSetHTML('docsCount', pipelineState.documents.length.toString());
            safeSetHTML('avgSimilarity', `${avgSimilarity}%`);
            safeSetHTML('genTime', `${pipelineState.stageTimings.generation || 0} ms`);
            safeSetHTML('totalTime', `${totalTime} ms`);
        }

        // Show retrieved documents
        function showRetrievedDocuments() {
            const docsPanel = safeGetElement('retrievedDocsPanel');
            const docsContainer = safeGetElement('retrievedDocs');

            if (!docsPanel || !docsContainer || pipelineState.documents.length === 0) return;

            docsPanel.style.display = 'block';

            const docsHTML = pipelineState.documents.map(doc => `
                <div class="doc-item fade-in">
                    <div>
                        <span class="doc-title">${doc.title}</span>
                        <span class="doc-similarity">${(doc.similarity * 100).toFixed(0)}% match</span>
                    </div>
                    <div class="doc-excerpt">${doc.excerpt}</div>
                </div>
            `).join('');

            safeSetHTML('retrievedDocs', docsHTML);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Ensure all critical elements exist
            const criticalElements = ['queryInput', 'processBtn', 'pipelineStages', 'errorMessage', 'successMessage'];
            let allElementsExist = true;

            criticalElements.forEach(id => {
                if (!safeGetElement(id)) {
                    console.error(`Critical element missing: ${id}`);
                    allElementsExist = false;
                }
            });

            if (!allElementsExist) {
                console.error('Some critical elements are missing. Please check the HTML structure.');
            }

            // Add enter key support for query input
            const queryInput = safeGetElement('queryInput');
            if (queryInput) {
                queryInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        processWithRAG();
                    }
                });
            }
        });
    </script>
</body>

</html>